# ä¼šè¯åˆ†ç»„åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

æœ¬åŠŸèƒ½ä¸º Chatlog é¡¹ç›®æ·»åŠ äº†å¾®ä¿¡ä¼šè¯çš„æ™ºèƒ½åˆ†ç»„æ˜¾ç¤ºåŠŸèƒ½ï¼Œæ”¯æŒï¼š

1. **ç½®é¡¶ä¼šè¯** - æ˜¾ç¤ºåœ¨æœ€ä¸Šæ–¹ï¼Œæ”¯æŒæŠ˜å 
2. **æ™®é€šä¼šè¯** - æ˜¾ç¤ºåœ¨ä¸­é—´ï¼Œæ­£å¸¸æ’åˆ—
3. **æœ€å°åŒ–ä¼šè¯** - åˆå¹¶æ˜¾ç¤ºï¼Œç‚¹å‡»å±•å¼€

æ‰€æœ‰æŠ˜å /å±•å¼€çŠ¶æ€é€šè¿‡ localStorage æŒä¹…åŒ–ä¿å­˜ã€‚

## åç«¯å®ç°

### æ•°æ®æ¨¡å‹æ‰©å±•

åœ¨ `internal/model/session.go` ä¸­ï¼Œ`Session` ç»“æ„ä½“æ–°å¢äº†ä¸‰ä¸ªå­—æ®µï¼š

```go
type Session struct {
    // ... åŸæœ‰å­—æ®µ ...

    // æ–°å¢å­—æ®µ
    IsTopPinned  bool   `json:"isTopPinned,omitempty"`  // æ˜¯å¦ç½®é¡¶
    IsHidden     bool   `json:"isHidden,omitempty"`     // æ˜¯å¦æœ€å°åŒ–
    SortOrder    int64  `json:"sortOrder,omitempty"`    // æ’åºæ—¶é—´æˆ³
}
```

### WeChat 4.x æ”¯æŒ

**æ£€æµ‹é€»è¾‘** (`internal/model/session_v4.go`):

```go
// ç½®é¡¶åˆ¤æ–­ï¼šsort_timestamp è¿œå¤§äº last_timestamp
const pinnedThreshold = 86400 * 365 * 10 // 10å¹´
isTopPinned := s.SortTimestamp > int64(s.LastTimestamp) + pinnedThreshold

// æœ€å°åŒ–åˆ¤æ–­ï¼šis_hidden å­—æ®µ
isHidden := s.IsHidden == 1
```

**æ•°æ®åº“å­—æ®µ**:
- `sort_timestamp` - æ’åºæ—¶é—´æˆ³ï¼ˆç½®é¡¶æ—¶è®¾ä¸ºå¾ˆå¤§çš„å€¼ï¼‰
- `is_hidden` - æœ€å°åŒ–æ ‡è®°ï¼ˆ1=å·²æœ€å°åŒ–ï¼‰

### WeChat 3.x æ”¯æŒ

**å­—æ®µ**:
- `nOrder` - æ’åºåºå·ï¼ˆç”¨ä½œ sortOrderï¼‰
- `parentRef` - å¯èƒ½ç”¨äºåˆ†ç»„æ ‡è®°ï¼ˆå¾…éªŒè¯ï¼‰

**æ³¨æ„**: WeChat 3.x æ²¡æœ‰ `is_hidden` å­—æ®µï¼Œéœ€è¦é€šè¿‡å®é™…æ•°æ®åˆ†æ `parentRef` çš„å«ä¹‰ã€‚

## å‰ç«¯å®ç°

### API ç±»å‹å®šä¹‰

`web/src/libs/ChatlogAPI.ts`:

```typescript
export interface Session {
  userName: string;
  nOrder: number;
  parentRef: string;
  nickName: string;
  content: string;
  nTime: string;
  nUnReadCount: number;
  avatarUrl?: string;

  // æ–°å¢å­—æ®µ
  isTopPinned?: boolean;
  isHidden?: boolean;
  sortOrder?: number;
}
```

### ç»„ä»¶ä½¿ç”¨

å¼•å…¥æ–°çš„ `EnhancedSessionList` ç»„ä»¶ï¼š

```tsx
import { EnhancedSessionList } from '@/components/chatlog/EnhancedSessionList';

export default function SessionsPage() {
  return <EnhancedSessionList />;
}
```

### åŠŸèƒ½ç‰¹æ€§

1. **è‡ªåŠ¨åˆ†ç»„**
   - ç½®é¡¶ä¼šè¯ï¼šè“è‰²èƒŒæ™¯å¡ç‰‡ï¼Œæ˜¾ç¤º ğŸ“Œ å›¾æ ‡
   - æ™®é€šä¼šè¯ï¼šé»˜è®¤æ ·å¼
   - æœ€å°åŒ–ä¼šè¯ï¼šç°è‰²è¾¹æ¡†ï¼Œåˆå§‹æŠ˜å 

2. **äº¤äº’åŠŸèƒ½**
   - ç‚¹å‡»ç½®é¡¶åŒºåŸŸæ ‡é¢˜ï¼šæŠ˜å /å±•å¼€ç½®é¡¶ä¼šè¯
   - ç‚¹å‡»æœ€å°åŒ–åŒºåŸŸæ ‡é¢˜ï¼šå±•å¼€/æŠ˜å æœ€å°åŒ–ä¼šè¯
   - çŠ¶æ€è‡ªåŠ¨ä¿å­˜åˆ° localStorage

3. **æŒä¹…åŒ–å­˜å‚¨**
   - `chatlog_pinned_collapsed` - ç½®é¡¶åŒºåŸŸæŠ˜å çŠ¶æ€
   - `chatlog_minimized_expanded` - æœ€å°åŒ–åŒºåŸŸå±•å¼€çŠ¶æ€

## ä½¿ç”¨ç¤ºä¾‹

### åç«¯ API å“åº”

```json
{
  "items": [
    {
      "userName": "user123",
      "nickName": "å¼ ä¸‰",
      "content": "æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ",
      "nTime": "2025-11-09T12:00:00+08:00",
      "nUnReadCount": 5,
      "isTopPinned": true,
      "isHidden": false,
      "sortOrder": 9999999999
    },
    {
      "userName": "user456",
      "nickName": "æå››",
      "content": "å¥½çš„",
      "nTime": "2025-11-09T11:00:00+08:00",
      "nUnReadCount": 0,
      "isTopPinned": false,
      "isHidden": false,
      "sortOrder": 1731127200
    },
    {
      "userName": "user789",
      "nickName": "ç‹äº”",
      "content": "çŸ¥é“äº†",
      "nTime": "2025-11-08T10:00:00+08:00",
      "nUnReadCount": 0,
      "isTopPinned": false,
      "isHidden": true,
      "sortOrder": 1731040800
    }
  ],
  "total": 3
}
```

### å‰ç«¯æ˜¾ç¤ºæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Œ ç½®é¡¶ä¼šè¯ [2]           â–¼     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Œ å¼ ä¸‰  12:00  [5æ¡æœªè¯»]      â”‚
â”‚    æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ                  â”‚
â”‚                                 â”‚
â”‚ ğŸ“Œ èµµå…­  11:30                  â”‚
â”‚    æ˜å¤©è§                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ æ™®é€šä¼šè¯ [3]                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æå››  11:00                      â”‚
â”‚    å¥½çš„                          â”‚
â”‚                                 â”‚
â”‚ å­™ä¸ƒ  10:30                      â”‚
â”‚    æ”¶åˆ°                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â– æœ€å°åŒ–ä¼šè¯ [2]          â–¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŠ€æœ¯ç»†èŠ‚

### ç½®é¡¶åˆ¤æ–­é˜ˆå€¼

WeChat é€šè¿‡å°† `sort_timestamp` è®¾ç½®ä¸ºè¿œå¤§äºå½“å‰æ—¶é—´çš„å€¼æ¥å®ç°ç½®é¡¶ï¼š

```go
const pinnedThreshold = 86400 * 365 * 10 // 10 years in seconds
```

å¦‚æœ `sort_timestamp - last_timestamp > 10å¹´`ï¼Œåˆ™è®¤ä¸ºè¯¥ä¼šè¯è¢«ç½®é¡¶ã€‚

### æ’åºè§„åˆ™

1. åç«¯æŒ‰ `sort_timestamp` DESC æ’åºï¼ˆç½®é¡¶ä¼šè¯è‡ªç„¶åœ¨å‰ï¼‰
2. å‰ç«¯æŒ‰ç±»å‹åˆ†ç»„ï¼ˆç½®é¡¶ > æ™®é€š > æœ€å°åŒ–ï¼‰
3. æ¯ç»„å†…éƒ¨ä¿æŒåŸæœ‰æ’åº

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ `useMemo` ç¼“å­˜åˆ†ç»„ç»“æœ
- localStorage çŠ¶æ€ä»…åœ¨å˜åŒ–æ—¶æ›´æ–°
- æŠ˜å çŠ¶æ€ä¸å½±å“æ•°æ®åŠ è½½

## å¾…å®Œå–„åŠŸèƒ½

1. **WeChat 3.x ç½®é¡¶æ£€æµ‹**
   - éœ€è¦åˆ†æå®é™…æ•°æ®ä¸­ `parentRef` çš„å€¼
   - å¯èƒ½éœ€è¦é¢å¤–çš„é˜ˆå€¼åˆ¤æ–­é€»è¾‘

2. **macOS ç‰ˆæœ¬æ”¯æŒ**
   - éœ€è¦æµ‹è¯• Darwin V3 ç‰ˆæœ¬çš„æ•°æ®ç»“æ„
   - å¯èƒ½éœ€è¦è°ƒæ•´ `SessionDarwinV3` çš„ Wrap å‡½æ•°

3. **åŠ¨æ€é˜ˆå€¼é…ç½®**
   - å°†ç½®é¡¶åˆ¤æ–­é˜ˆå€¼è®¾ä¸ºå¯é…ç½®é¡¹
   - æ”¯æŒä¸åŒç‰ˆæœ¬çš„è‡ªå®šä¹‰é˜ˆå€¼

4. **æµ‹è¯•è¦†ç›–**
   - æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯åˆ†ç»„é€»è¾‘
   - E2E æµ‹è¯•éªŒè¯å‰ç«¯äº¤äº’

## ç›¸å…³æ–‡ä»¶

### åç«¯
- `internal/model/session.go` - Session æ¨¡å‹å®šä¹‰
- `internal/model/session_v4.go` - WeChat 4.x é€‚é…
- `internal/wechatdb/datasource/v4/datasource.go` - V4 æ•°æ®æº
- `internal/wechatdb/datasource/windowsv3/datasource.go` - V3 æ•°æ®æº

### å‰ç«¯
- `web/src/libs/ChatlogAPI.ts` - API ç±»å‹å®šä¹‰
- `web/src/components/chatlog/EnhancedSessionList.tsx` - å¢å¼ºä¼šè¯åˆ—è¡¨ç»„ä»¶

## è´¡çŒ®æŒ‡å—

å¦‚æœéœ€è¦ä¿®æ”¹åˆ†ç»„é€»è¾‘æˆ–æ·»åŠ æ–°åŠŸèƒ½ï¼š

1. åç«¯ä¿®æ”¹ `SessionV4.Wrap()` æˆ– `SessionV3.Wrap()` å‡½æ•°
2. å‰ç«¯ä¿®æ”¹ `EnhancedSessionList` ç»„ä»¶çš„ `groupedSessions` useMemo
3. æ›´æ–°ç›¸å…³æµ‹è¯•å’Œæ–‡æ¡£
