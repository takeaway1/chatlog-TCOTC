<style>
#preview {
    position: fixed;
    top: 60px;
    left: 40px;
    z-index: 9999;
    display: none;
    background: #1f2329;
    border: 1px solid #444;
    padding: 4px 4px 8px;
    border-radius: 8px;
    max-width: 720px;
    max-height: 520px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.45);
    color: #eee;
    font-size: 12px;
    resize: both;
    overflow: hidden;
}

#preview.dragging {
    opacity: .85;
    cursor: grabbing;
}

#preview .pv-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    margin: 0 2px 4px 2px;
    font-size: 12px;
    user-select: none;
    cursor: grab;
}

#preview .pv-header .title {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #9ecbff;
    font-weight: 600;
}

#preview button {
    background: #2d333b;
    border: 1px solid #555;
    color: #ddd;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    cursor: pointer;
}

#preview button:hover {
    background: #3a424b;
}

#preview-content {
    max-width: 100%;
    max-height: 470px;
    overflow: auto;
}

#preview-content img,
#preview-content video {
    max-width: 100%;
    max-height: 470px;
    display: block;
    border-radius: 4px;
}

#preview-content audio {
    width: 100%;
    margin-top: 4px;
}

#preview-content .audio-meta {
    margin-top: 4px;
    color: #bbb;
    font-size: 11px;
    font-family: monospace;
}
</style>

<div id="preview">
    <div class="pv-header">
        <span class="title" id="pv-title">È¢ÑËßà</span>
        <button id="pv-pin" title="Âõ∫ÂÆö/ÂèñÊ∂àÂõ∫ÂÆö">üìå</button>
        <button id="pv-close" title="ÂÖ≥Èó≠">‚úï</button>
    </div>
    <div id="preview-content"></div>
</div>

<script>
(function(){
    const pv = document.getElementById('preview');
    const pvc = document.getElementById('preview-content');
    const titleEl = document.getElementById('pv-title');
    const pinBtn = document.getElementById('pv-pin');
    const closeBtn = document.getElementById('pv-close');
    
    let activeLink = null;
    let hideTimer = null;
    let pinned = false;
    let dragState = null;
    let currentType = '';

    function esc(s) {
        return s.replace(/[&<>"']/g, c => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            '\'': '&#39;'
        }[c]));
    }

    function build(href, text) {
        let label = text || '';
        label = label.replace(/^[\[]|[\]]$/g, '');
        currentType = 'text';
        
        if (/\/image\//.test(href)) {
            currentType = 'image';
            return '<img src="' + href + '" loading="lazy" />';
        }
        
        if (/\/video\//.test(href)) {
            currentType = 'video';
            return '<video src="' + href + '" controls preload="metadata"></video>';
        }
        
        if (/\/voice\//.test(href)) {
            currentType = 'audio';
            return '<div class="audio-box"><audio src="' + href + '" controls preload="metadata"></audio><div class="audio-meta">Ëß£Êûê‰∏≠...</div></div>';
        }
        
        if (/Ë°®ÊÉÖ/.test(label) || /\.(gif|apng|webp)(\?|$)/i.test(href)) {
            currentType = 'emoji';
            return '<img src="' + href + '" style="max-width:100%;max-height:470px;display:block;" />';
        }
        
        if (/\/file\//.test(href)) {
            currentType = 'file';
            return '<div style="word-break:break-all;line-height:1.5;">Êñá‰ª∂: ' + esc(label) + '<br/><a href="' + href + '" target="_blank" style="color:#61afef;">‰∏ãËΩΩ</a></div>';
        }
        
        return '<div style="word-break:break-all;line-height:1.5;">' + esc(label) + '<br/><a href="' + href + '" target="_blank" style="color:#61afef;">ÊâìÂºÄ</a></div>';
    }

    function fmtDur(d) {
        if (!isFinite(d) || d <= 0) return 'Êú™Áü•';
        const s = Math.round(d);
        if (s >= 60) {
            const m = Math.floor(s / 60);
            const ss = s % 60;
            return m + 'm' + (ss < 10 ? '0' : '') + ss + 's';
        }
        return s + 's';
    }

    function parseLabelDuration(lbl) {
        const m1 = /ËØ≠Èü≥\((\d+)s\)/.exec(lbl);
        if (m1) return m1[1] + 's';
        
        const m2 = /ËØ≠Èü≥\((\d+)m(\d{1,2})s\)/.exec(lbl);
        if (m2) {
            const mm = m2[1], ss = m2[2];
            return mm + 'm' + (ss.length === 1 ? '0' + ss : ss) + 's';
        }
        return null;
    }

    function afterRender() {
        if (currentType === 'audio') {
            const audio = pvc.querySelector('audio');
            const meta = pvc.querySelector('.audio-meta');
            if (audio && meta) {
                const label = (activeLink ? activeLink.textContent : '').replace(/[\[\]]/g, '');
                const parsed = parseLabelDuration(label);
                if (parsed) {
                    meta.textContent = 'Êó∂Èïø: ' + parsed;
                }
                
                const update = () => {
                    if (isFinite(audio.duration) && audio.duration > 0) {
                        meta.textContent = 'Êó∂Èïø: ' + fmtDur(audio.duration);
                        return true;
                    }
                    return false;
                };
                
                audio.addEventListener('loadedmetadata', () => {
                    update();
                }, {once: true});
                
                let tries = 0;
                const timer = setInterval(() => {
                    if (update() || ++tries > 6) {
                        clearInterval(timer);
                    }
                }, 500);
                
                audio.load();
            }
        }
    }

    function adjustWidth() {
        if (dragState) return;
        const vw = window.innerWidth;
        const clamp = w => Math.min(w, vw - 40);
        
        switch (currentType) {
            case 'audio':
                pv.style.width = clamp(680) + 'px';
                break;
            case 'video':
                pv.style.width = clamp(720) + 'px';
                break;
            case 'file':
                pv.style.width = clamp(560) + 'px';
                break;
            case 'image':
            case 'emoji':
                pv.style.width = 'auto';
                break;
            default:
                pv.style.width = '420px';
        }
    }

    function showFor(a) {
        clearTimeout(hideTimer);
        activeLink = a;
        const href = a.getAttribute('href');
        pvc.innerHTML = build(href, a.textContent || '');
        titleEl.textContent = a.textContent || 'È¢ÑËßà';
        pv.style.display = 'block';
        adjustWidth();
        afterRender();
        positionNear(a);
    }

    function positionNear(a) {
        if (pinned || dragState) return;
        const rect = a.getBoundingClientRect();
        const pw = pv.offsetWidth;
        const ph = pv.offsetHeight;
        let x = rect.right + 12;
        let y = rect.top;
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        
        if (x + pw > vw - 8) x = rect.left - pw - 12;
        if (x < 8) x = 8;
        if (y + ph > vh - 8) y = vh - ph - 8;
        if (y < 8) y = 8;
        
        pv.style.left = x + 'px';
        pv.style.top = y + 'px';
    }

    function scheduleHide() {
        if (pinned) return;
        hideTimer = setTimeout(() => {
            if (pinned) return;
            activeLink = null;
            pv.style.display = 'none';
            pvc.innerHTML = '';
        }, 280);
    }

    // Event Listeners
    document.addEventListener('mouseover', e => {
        const a = e.target.closest('a.media');
        if (!a) return;
        if (a === activeLink) {
            clearTimeout(hideTimer);
            return;
        }
        showFor(a);
    });

    document.addEventListener('mousemove', e => {
        if (!activeLink || pinned || dragState) return;
        positionNear(activeLink);
    });

    pv.addEventListener('mouseenter', () => {
        clearTimeout(hideTimer);
    });

    pv.addEventListener('mouseleave', () => {
        scheduleHide();
    });

    document.addEventListener('mouseout', e => {
        const a = e.target.closest && e.target.closest('a.media');
        if (!a) return;
        if (pv.contains(e.relatedTarget)) return;
        scheduleHide();
    });

    pinBtn.addEventListener('click', () => {
        pinned = !pinned;
        pinBtn.style.opacity = pinned ? 1 : 0.6;
        if (!pinned) {
            scheduleHide();
        } else {
            clearTimeout(hideTimer);
        }
    });

    closeBtn.addEventListener('click', () => {
        pinned = false;
        activeLink = null;
        pv.style.display = 'none';
        pvc.innerHTML = '';
    });

    pv.querySelector('.pv-header').addEventListener('mousedown', e => {
        if (e.target === pinBtn || e.target === closeBtn) return;
        pinned = true;
        pinBtn.style.opacity = 1;
        dragState = {
            ox: e.clientX,
            oy: e.clientY,
            left: pv.offsetLeft,
            top: pv.offsetTop
        };
        pv.classList.add('dragging');
        e.preventDefault();
    });

    window.addEventListener('mousemove', e => {
        if (!dragState) return;
        const dx = e.clientX - dragState.ox;
        const dy = e.clientY - dragState.oy;
        let nl = dragState.left + dx;
        let nt = dragState.top + dy;
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        nl = Math.max(0, Math.min(vw - pv.offsetWidth, nl));
        nt = Math.max(0, Math.min(vh - pv.offsetHeight, nt));
        pv.style.left = nl + 'px';
        pv.style.top = nt + 'px';
    });

    window.addEventListener('mouseup', () => {
        if (dragState) {
            dragState = null;
            pv.classList.remove('dragging');
        }
    });

    window.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            pinned = false;
            pv.style.display = 'none';
            pvc.innerHTML = '';
            activeLink = null;
        }
    });
})();
</script>